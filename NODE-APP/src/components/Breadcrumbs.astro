---
interface BreadcrumbInput {
  label: string;
  href?: string | URL | null;
}

interface Props {
  items?: BreadcrumbInput[];
  class?: string;
}

const { items = [], class: className = "" } = Astro.props as Props;
const currentPath = Astro.url?.pathname ?? "/";
const baseSite = Astro.site ?? new URL("https://tc.yinyanghouse.com/");
const base = typeof baseSite === "string" ? new URL(baseSite) : baseSite;
const faviconUrl = new URL("/favicon.ico", base).toString();

const toUrlString = (value: string | URL | null | undefined) => {
  if (value instanceof URL) return value.toString();
  if (typeof value === "string") {
    const trimmed = value.trim();
    return trimmed.length ? trimmed : null;
  }
  return null;
};

const ensureRelative = (value: string) => {
  if (value.startsWith("http://") || value.startsWith("https://")) {
    return value;
  }
  if (value.startsWith("/")) {
    return value;
  }
  return `/${value}`;
};

type NormalizedItem = {
  label: string;
  href: string;
  isHome: boolean;
};

const allItems = [{ label: "Home", href: "/", isHome: true }, ...items];

const normalizedItems = allItems
  .map((item, index, array) => {
    const isLast = index === array.length - 1;
    const href = toUrlString(item.href) ?? (isLast ? currentPath : null);
    if (!href) return null;
    const label = item.label.trim();
    if (!label) return null;
    return {
      label,
      href: ensureRelative(href),
      isHome: Boolean((item as { isHome?: boolean }).isHome),
    };
  })
  .filter((value): value is NormalizedItem => Boolean(value));

const makeAbsolute = (value: string) => new URL(value, base).toString();
---
{normalizedItems.length > 0 && (
  <nav
    class={`breadcrumbs flex items-center w-full ${className}`.trim()}
    itemscope
    itemtype="https://schema.org/BreadcrumbList"
    aria-label="Breadcrumb"
  >
    <ul class="flex items-center gap-1 w-full">
      {normalizedItems.map((item, index) => {
        const isLast = index === normalizedItems.length - 1;
        return (
          <li
            itemprop="itemListElement"
            itemscope
            itemtype="https://schema.org/ListItem"
            class="flex items-center gap-1 text-[0.7rem] text-gray-600 dark:text-gray-300"
          >
            {!isLast ? (
              <a
                itemprop="item"
                href={item.href}
                class="breadcrumb-link flex items-center gap-1 text-current"
              >
                {item.isHome && (
                  <img
                    src={faviconUrl}
                    alt="Home"
                    width="14"
                    height="14"
                    class="h-[14px] w-[14px] flex-none"
                  />
                )}
                <span itemprop="name" class="truncate">
                  {item.label}
                </span>
              </a>
            ) : (
              <span class="flex items-center gap-1 text-gray-900 dark:text-gray-100">
                {item.isHome && (
                  <img
                    src={faviconUrl}
                    alt="Home"
                    width="14"
                    height="14"
                    class="h-[14px] w-[14px] flex-none"
                  />
                )}
                <span itemprop="name" class="truncate">
                  {item.label}
                </span>
              </span>
            )}
            {isLast && <meta itemprop="item" content={makeAbsolute(item.href)} />}
            <meta itemprop="position" content={(index + 1).toString()} />
            {!isLast && (
              <span class="ml-1 flex items-center text-gray-400 dark:text-gray-500" aria-hidden="true">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  class="h-3 w-3 stroke-current"
                  fill="none"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="m9 5.25 6 6-6 6"
                  />
                </svg>
              </span>
            )}
          </li>
        );
      })}
    </ul>
  </nav>
)}
